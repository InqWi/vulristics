import functions_source_vulners
import re
import json
import datetime
import os

today = datetime.date.today()

main_date = str(today)  # today

print("Making report for today date: " + main_date)

if os.path.exists("report/daily_exploits_" + main_date):
    print("Report for " + main_date + " already exists!")
    exit()

f = open("data/vulners_exploit/all_exploits_report_data.json", "r")
all_exploits = json.loads(f.read())
f.close()

exploits = dict()

raw_results = functions_source_vulners.get_last_vulners_exploits_by_release_date()

for search_result in raw_results['data']['search']:
    if not search_result['_id'] in all_exploits:
        if "https://vulners.com" in search_result['_source']['vhref']:
            exploits[search_result['_id']] = {'href': search_result['_source']['vhref'],
                                              'title': search_result['_source']['title']}

exploit_list = list(exploits.keys())
exploit_list.sort()

n = 1
post = "#Vulristics #DailyExploits for <b>" + main_date + "</b> based on #Vulners data\n\n"
if exploits != dict():
    for exploit in exploit_list:
        title = re.sub("&#039;", "'", exploits[exploit]['title'])
        title = re.sub("<", "&lt;", title)
        title = re.sub(">", "&gt;", title)
        post += str(n) + ". " + "<a href=\"" + exploits[exploit]['href'] + "\">" + exploit + "</a>" + " - " + title + "\n"
        n += 1
else:
    post += "No new exploits were found :-("
post = re.sub("\n$", "", post)
print(post)

f = open("report/daily_exploits_" + main_date, "w")
f.write(post)
f.close()

if exploits != dict():
    for exploit in exploit_list:
        all_exploits[exploit] = main_date

f = open("data/vulners_exploit/all_exploits_report_data.json", "w")
f.write(json.dumps(all_exploits, indent=4))
f.close()
